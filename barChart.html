<!DOCTYPE html>
<html lang="en">

<head>
    <title>Area Chart</title>

    <link href="https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Gotu|Roboto&display=swap" rel="stylesheet">

    <style>
        #wrapper3 {
            position: relative;
            margin-top: 16px;
        }

        body {
            font-family: 'Gotu', 'Roboto', sans-serif;
            color: #7E7E7E;
            display: flex;
            margin-left: 16px;
        }

        .bar {
            fill: #3BADCC;
        }

        .bar:hover {
            stroke: #e31a1c;
            stroke-width: 1.5px;
        }

        .tooltip {
            height: auto;
            transition: all 0.1s ease-out;
            pointer-events: none;
            padding: 8px;
            background: #fff;
            border: .5px solid #f5f5f5;
            text-align: left;
            line-height: 1.4em;
            font-size: .7em;
            font-weight: 600;
            border-radius: 5px;
            box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.15);
        }

        .tooltip:before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 8px;
            height: 8px;
            background: white;
            border: 1px solid #ddd;
            border-top-color: transparent;
            border-left-color: transparent;
            transform: translate(-50%, 50%) rotate(45deg);
            transform-origin: center center;
            z-index: 10;
        }
    </style>
</head>

<body>
    <div class="wrapper3" id="wrapper3"></div>

    <script src="https://d3js.org/d3.v5.js"></script>
    <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <script>
        async function drawBars() {

            // access data

            const dataset = await d3.csv("data/area-grinnell.csv")
            console.log(dataset);

            // alphabetize by year
            dataset.sort(function (a, b) {
                return a.Year - b.Year
            });

            // create chart dimensions
            const width = 220
            let dimensions = {
                width: width,
                height: 160,
                margin: {
                    top: 15,
                    right: 15,
                    bottom: 40,
                    left: 70,
                },
            }
            dimensions.boundedWidth = dimensions.width - dimensions.margin.left - dimensions.margin.right
            dimensions.boundedHeight = dimensions.height - dimensions.margin.top - dimensions.margin.bottom

            // draw canvas
            const wrapper3 = d3.select("#wrapper3")
                .append("svg")
                .attr("width", dimensions.width + dimensions.margin.left + dimensions.margin.right)
                .attr("height", dimensions.height + dimensions.margin.top + dimensions.margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + dimensions.margin.left + "," + dimensions.margin.top + ")");

            const bounds = wrapper3.append("g")
                .attr("transform", "translate(" + dimensions.margin.left + "," + dimensions.margin.top + ")");

            // format the data
            dataset.forEach(function (d) {
                d.area = +d.AREA
            });

            const area = d => d.area
            const yAccessor = d => d.length
            const xAccessor = d => d.Year

            // create tooltip
            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .text("a simple tooltip")

            // create scales
            const xScale = d3.scaleBand()
                .domain(dataset.map(function (d) {
                    return d.Year;
                }))
                .range([0, dimensions.boundedWidth])
                .padding(0.2)

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(dataset, function (d) {
                    return d.area;
                })])
                .range([dimensions.boundedHeight, 0])
                .nice();

            // add bars
            const bars = wrapper3.selectAll(".bar")
                .data(dataset)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function (d) {
                    return xScale(d.Year);
                })
                .attr("width", xScale.bandwidth())

                // no bars on window load
                .attr("height", function (d) {
                    return dimensions.boundedHeight - yScale(0);
                }) // bars equal to 0
                .attr("y", function (d) {
                    return yScale(0);
                })

                .on("mouseover", function (d) {
                    const format = d3.format(",.2f")
                    return tooltip 
                    .style("visibility", "visible")
                    .html(format(d.AREA) + " m&sup2;" + "<br>" + 
                    format(d.AREA * 0.000247105) + " acres")
                        
                })
                .on("mousemove", function () {
                    return tooltip
                        .style("top", (event.pageY - 80) + "px")
                        .style("left", (event.pageX - 40) + "px");
                })
                .on("mouseout", function () {
                    return tooltip
                        .style("visibility", "hidden");
                });

            //add x-axis
            const xAxis = wrapper3.append("g")
                .attr("transform", "translate(0," + dimensions.boundedHeight + ")")
                .call(d3.axisBottom(xScale));

            // add y-axis
            const yAxis = wrapper3.append("g")
                .call(d3.axisLeft(yScale).ticks(5));

            // label y-axis
            const yAxisLabel = yAxis.append("text")
                .attr("class", "y-axis-label")
                .attr("fill", "#7E7E7E")
                .attr("transform", "rotate(-90)")
                .attr("x", -dimensions.margin.top - 30)
                .attr("y", -dimensions.margin.left + 12)
                .attr("text-anchor", "middle")
                .html("Area m&sup2;");

            // animate bars
            const animation = wrapper3.selectAll("rect")
                .transition()
                .duration(800)
                .attr("y", function (d) {
                    return yScale(d.area);
                })
                .attr("height", function (d) {
                    return dimensions.boundedHeight - yScale(d.area);
                })
                .delay(function (d, i) {
                    return (i * 100)
                })
        };
        drawBars()
    </script>
</body>

</html>